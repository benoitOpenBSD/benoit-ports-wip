--- src/netd.c.orig	Sun Sep  5 05:37:57 2010
+++ src/netd.c	Sun Oct 10 17:52:17 2010
@@ -77,7 +77,10 @@
 #include <sys/wait.h>
 #include <time.h>
 #include <assert.h>
+#include <pwd.h>
 
+#define ZIPROXY_USER "_ziproxy"
+
 #include "cfgfile.h"
 #include "log.h"
 #include "ziproxy.h"
@@ -211,6 +214,27 @@
 	   to stderr for now. */
 	error_log_pre_init ();
 	
+        if (geteuid() == 0) {
+               /* We are root; drop privileges */
+               struct passwd *pw;
+
+               if ((pw = getpwnam(ZIPROXY_USER)) == NULL) {
+                       fprintf(stderr, "No user %s.\n", ZIPROXY_USER);
+                       exit(1);
+               }
+
+               if (setgroups(1, &pw->pw_gid) ||
+                               setegid(pw->pw_gid) ||
+                               setgid(pw->pw_gid) ||
+                               seteuid(pw->pw_uid) ||
+                               setuid(pw->pw_uid)) {
+                       fprintf(stderr, "can not drop privileges to '%s'\n",
+                                       ZIPROXY_USER);
+                       exit(1);
+               }
+               endpwent();
+        }
+
 	command_options.addr_low.s_addr=0;
 
 	/* set defaults */
